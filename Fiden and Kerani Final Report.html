<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Emery Kerani and Spencer Fiden">
<meta name="dcterms.date" content="2025-12-18">

<title>Oregone Wild:</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="Fiden and Kerani Final Report_files/libs/clipboard/clipboard.min.js"></script>
<script src="Fiden and Kerani Final Report_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="Fiden and Kerani Final Report_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="Fiden and Kerani Final Report_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="Fiden and Kerani Final Report_files/libs/quarto-html/popper.min.js"></script>
<script src="Fiden and Kerani Final Report_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Fiden and Kerani Final Report_files/libs/quarto-html/anchor.min.js"></script>
<link href="Fiden and Kerani Final Report_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Fiden and Kerani Final Report_files/libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Fiden and Kerani Final Report_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Fiden and Kerani Final Report_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Fiden and Kerani Final Report_files/libs/bootstrap/bootstrap-9e3ffae467580fdb927a41352e75a2e0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Oregone Wild:</h1>
<p class="subtitle lead">An Examination of Healthcare Spending in Oregon</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Emery Kerani and Spencer Fiden </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 18, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<section id="background" class="level3">
<h3 class="anchored" data-anchor-id="background">Background</h3>
<p>Our dataset is American personal health care spending between 1980 and 2015, divided by state. The spending itself is divided by type in the <code>Item</code> column. The definitions of these types were taken from the Centers for Medicare &amp; Medicaid Services’ <em>National Health Expenditure Accounts: Methodology Paper</em> from 2023, which can be found <a href="https://www.cms.gov/files/document/definitions-sources-and-methods.pdf">here</a>.</p>
<p>While several of the spending types are fairly intuitive, the following require more careful definition. <strong>Personal Health Care</strong> is the aggregation of all other items, as this dataset is composed of all types of personal health care spending. <strong>Other Professional Services</strong> serves as a catch-all category for payment to other health practitioners, including chiropractors, optometrists, and podiatrists, in addition to physical, occupational, and speech therapists. <strong>Other Health, Residential, and Personal Care</strong> (OHRPC) generally refers to services provided in non-traditional settings (e.g.&nbsp;school and worksite healthcare, residential mental health and substance abuse facilities, etc.). <strong>Durable Medical Products</strong> refers to the retail sales of persistent items with a useful life of over three years, such as oxygen and hearing aids, glasses and contact lenses. <strong>Other Non-durable Medical Products</strong> covers spending on items with a short useful life or that are single-use (e.g.&nbsp;needles, thermometers, and surgical dressings), as well as non-prescription drugs. For detailed definitions of the categories not covered here, we invite you to refer back to the link above.</p>
</section>
<section id="research-question" class="level3">
<h3 class="anchored" data-anchor-id="research-question">Research question</h3>
<p>Our primary research question for this project is how Oregon’s healthcare spending compares to the spending of other US states. This is important chiefly because of the federalist structure of the US healthcare system, which for the most part leaves each state to govern its own healthcare. As a result, there is quite a bit of variation in healthcare policy between states (for example, in which types of care are covered under Medicaid), which in turn fundamentally alters how people experience healthcare between states. Focusing on one state—in this case, the state we spend most of our time in—allows us to examine the specific implications of this distributed system for our own lives.</p>
</section>
</section>
<section id="methods" class="level2">
<h2 class="anchored" data-anchor-id="methods">Methods</h2>
<section id="outside-datasets" class="level3">
<h3 class="anchored" data-anchor-id="outside-datasets">Outside Datasets</h3>
<p>Several variables from the original dataset feature heavily in our analysis: <code>Year</code>, <code>State_Name</code>, and <code>Item</code> are the core holdovers from the original data. <code>Year</code> refers to the year in which the spending in question happened, ranging from 1980-2014. <code>State_Name</code> catalogues the state in which money was spent, while <code>Item</code> refers to the type of healthcare money was spent on (see the background section for information on specific type definitions).</p>
<p><code>Spending</code>, which is the amount of money spent on a given type of healthcare in a given state and year, features indirectly in our analysis as it was used to derive other variables. We used two datasets to standardize the spending measure between states and across time. The first dataset contains the population of each state from 1950 to 2024, which we used to create our <code>Population</code> variable. This was uploaded in <code>.csv</code> format to <a href="https://github.com/JoshData/historical-state-population-csv/blob/primary/historical_state_population_by_year.csv">Github</a> by user JoshData, who derived the population counts from the US Census’s annual population estimates. <code>Spending_Percap</code> was derived from <code>Spending</code> and <code>Population</code>, by first multiplying <code>Spending</code> by 1,000,000 (in order to convert the unit to single dollars instead of millions) and then dividing it by <code>Population</code>. This gives us the spending in straight USD per person in each state, which standardizes the spending metric across states with different populations.</p>
<p>The second dataset we used holds the medical care consumer price index (CPI) for urban consumers, which we used to standardize spending across time by accounting for inflation. To do this, we incorporated the medical care CPI for urban consumers under the variable <code>Inflation_Val</code>. CPI is a widely-used metric of inflation, which in our case uses an estimate of the price of medical care relative to a standardized base period; for our purposes, this means that <code>Spending_Percap</code> will be interpreted using medical care costs in 1982-1984 (the most common index) as a baseline. These data were downloaded directly from the US <a href="https://data.bls.gov/dataViewer/view/timeseries/CUUR0000SAM">Bureau of Labor Statistics</a>, and are available for any time frame between 1935 and 2025. In order to put the CPI into action, we calculated <code>Inflation_Adjusted</code> using the formula <span class="math inline">\(\frac{SP}{IV} * 100\)</span>, where <em>SP</em> is <code>Spending_Percap</code> and <em>IV</em> is <code>Inflation_Val</code>. <code>Inflation_Adjusted</code> is our final version of <code>Spending</code>, as it now accounts for variations due to both time and size of states. Finally, the variable <code>OR</code> was derived from <code>State_Name</code> and used for visualization to denote whether or not a given state is Oregon.</p>
</section>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<p>To explore how Oregon compares to other states in healthcare spending, we first looked at overall spending. Oregon is shown in green, while the other states are in light gray, and the US median is shown in blue.</p>
<div id="2f9b0327" class="cell" data-execution_count="2">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Fiden%20and%20Kerani%20Final%20Report_files/figure-html/cell-3-output-1.png" width="609" height="467" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The state with very high spending in the personal health care category is the District of Columbia, which is an outlier. This is most likely because a notable proportion of DC’s inhabitants—namely US senators, congressmen, and their staffers—enjoy healthcare that is essentially subsidized by the federal government through their <a href="https://www.cnbc.com/2017/07/25/heres-how-much-members-of-congress-pay-for-their-health-insurance.html">insurance</a>.</p>
</div>
</div>
<p>We chose to use the US median as a metric of comparison for this graphic rather than the mean because, as noted above, DC is an outlier that significantly skews the mean; this makes the median a better measure of the true middle of the spending range. By comparing Oregon’s spending to the median, we can see that Oregon has consistently been in the lower half of total spending. Interestingly, Oregon diverged the most from the US median between 1990 and 1997, before Oregon’s spending started to rise and eventually overtook the US median in 2014. Though there was variation along the way, every state’s spending rose between 1980 and 2014.</p>
<p>Next, we looked at Oregon’s spending by type compared to other states. As with before, other states are marked in gray with Oregon in green and the US median in blue.</p>
<div id="78e94401" class="cell" data-execution_count="3">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Fiden%20and%20Kerani%20Final%20Report_files/figure-html/cell-4-output-1.png" width="1488" height="569" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>What stands out in this visualization is the sheer amount of variance, both in how specific types of spending have behaved over time and in Oregon’s spending relative to other states. While Oregon is fairly middling in terms of aggregate spending, we can see here that for certain types (other professional services, dental services, and OHRPC) it was very much in the upper percentile of spending, while for others (hospital care, home health care, prescription drugs, and durable medical products) Oregon was among the states spending the least. Additionally, Oregon’s spending has remained relatively stable for hospital care, physician and clinical services, home health care, and nursing home care, while rising for other professional services, prescription drugs, and OHRPC. Non-durable medical products is the only spending category which has seen a decline in spending over time for all states. On the whole, personal healthcare spending has risen for every state between 1980 and 2014.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Oregon’s high spending on dental care could be partially explained by the fact that Medicaid in Oregon covers many dental services, thus enabling more people to seek care. Dental coverage varies by state, and many other states’ Medicaid programs have limited or no coverage (more information <a href="https://www.chcs.org/media/Medicaid-Adult-Dental-Benefits-Overview-Appendix_091519.pdf">here</a>).</p>
</div>
</div>
<div id="345a2fe0" class="cell" data-execution_count="4">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Fiden%20and%20Kerani%20Final%20Report_files/figure-html/cell-5-output-1.png" width="964" height="449" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>After comparing Oregon’s spending to that of other states, we also looked at the distribution of spending within Oregon specifically. As noted in the graphic, hospital and physician/clinical services made up the majority of the state’s spending—those two categories alone accounted for almost 60% of Oregon’s per capita spending in 2014. Out of the remaining types of spending, dental services accounted for the most spending until about 1997, when it was overtaken by prescription drugs and OHRPC; home health care and durable medical products have consistently remained at the bottom of the spending distribution, where they were joined by spending on other non-durable medical products around 2005 after that category had been steadily declining.</p>
<section id="modeling-spending-on-non-durable-medical-products" class="level3">
<h3 class="anchored" data-anchor-id="modeling-spending-on-non-durable-medical-products">Modeling Spending on Non-Durable Medical Products</h3>
<p>Since around 2000, Oregon’s inflation-adjusted spending on other non-durable medical products has been decreasing at a relatively stable rate. This may be due to the consistent need for these items, which include supplies such as gloves, masks, and bandages, alongside a decreasing cost of producing them as technologies advance. A linear regression analysis indicates that there is a strong negative correlation between spending on non-durable medical products and time.</p>
<div id="48d7f7c1" class="cell" data-execution_count="5">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Fiden%20and%20Kerani%20Final%20Report_files/figure-html/cell-6-output-1.png" width="470" height="508" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>A linear regression analysis (displayed above) indicates that there is a strong negative correlation between spending on non-durable medical products (when adjusted for inflation) and time. The equation of the linear regression model we generated is <span class="math inline">\(-0.68*x + 2033.54\)</span>, meaning that during the timeframe in question Oregon’s spending on other non-durable medical products decreased by approximately 68 cents per person per year. The model’s R^2 score is 97.36%, which is quite high and tells us that by this measure our model explains nearly all of the variance in spending on other non-durable medical products. However, R^2 is not enough to evaluate a model without also graphing the variations among these data.</p>
<div class="panel-fill panel-grid">
<div class="g-col-24">
<div id="2d0014fe" class="cell panel-fill quarto-layout-panel" data-execution_count="7" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="Fiden%20and%20Kerani%20Final%20Report_files/figure-html/cell-8-output-1.png" class="img-fluid" width="594"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="Fiden%20and%20Kerani%20Final%20Report_files/figure-html/cell-8-output-2.png" class="img-fluid" width="585"></p>
</div>
</div>
</div>
</div>
</div>
<p>Upon examining the Q-Q plot generated from our model, it appears that the residuals are moderately normally distributed, with some variation. Unfortunately, there does appear to be a pattern in our residuals plot, which indicates that the relationship between time and Oregon’s non-durable medical products spending may be better accounted for by using a non-linear model.</p>
<p>Part of what causes this pattern in the residuals is a spike in spending in 1997. This irregularity coincides with the <a href="https://www.govinfo.gov/content/pkg/PLAW-105publ115/pdf/PLAW-105publ115.pdf">FDA Modernization Act of 1997</a>, which aimed to reduce unnecessary burdens caused by FDA regulations. A significant portion of the act is dedicated to drugs and medical devices, which in part explains the sudden decrease in spending on non-durable medical products after it was passed. The increase before the act was passed may represent a trend of increasing costs to keep up with the previous regulations, which then relaxed and caused prices to decrease.</p>
<p>Overall, the decreasing spending on non-durable medical products over time may be associated with technological improvements that allow common, single-use medical products to be manufactured more effectively and cheaply.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>The major limitation of our project is that the CPI measure we used to account for inflation is not perfect. While it accomplished our main goal of standardizing spending for all states across the board, the CPI’s nature as the <em>urban</em> consumer price index means that it cannot accurately account for any variations between states where the population is primarily urban and those that are primarily rural. Additionally, the way data are stored in this dataset makes it somewhat hard to draw conclusions; since we are given only spending data with no context, we can’t be certain what is driving any spending trends across time or in Oregon. As just one example, we do not know whether low spending on prescription drugs in Oregon results from a smaller percentage of the population buying prescription drugs or whether prescription drugs are cheaper in Oregon than in other states. Future work could potentially address this dilemma by incorporating data on the number of spenders for each category rather than the rough estimate provided by our per capita adjustments.</p>
<p>With those limitations in mind, it is still noteworthy that healthcare spending has generally risen over time, indicating that either more people are requiring healthcare, it’s becoming more expensive, or some combination of both. However, we have also shown that varying circumstances between states significantly influence the level of spending. Spending tends to be higher when people can consistently access care, as is the case for those in the District of Columbia and for dental services in Oregon. On the other hand, spending can also be brought down or otherwise impacted by measures such as the FDA Modernization Act. Without more data we cannot make a judgement about whether these variations and changes are necessarily good or bad, but as many people across the country search for solutions to a healthcare system they perceive to be broken, we believe that the knowledge that change <em>can</em> be made through policy is significant on its own.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>